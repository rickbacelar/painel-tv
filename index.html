<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Resultados - MC Soluções</title>
<style>
:root{--orange:#FF6B00;--dark:#2E2E2E;--bg:#F5F5F6;--card:#FFFFFF;--muted:#8A8A8A;}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Inter',system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--dark);}
.app{display:flex;flex-direction:column;height:100%;}
header{background:linear-gradient(90deg,var(--dark) 0%, #3C3C3C 100%);color:white;padding:20px 40px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 4px 12px rgba(0,0,0,0.3);}
.header-title{display:flex;align-items:center;gap:20px;font-weight:800;font-size:48px;letter-spacing:0.5px;}
.logo-dot{width:24px;height:24px;border-radius:6px;background:var(--orange);box-shadow:0 3px 10px rgba(255,107,0,0.5);}
.logo-img{height:110px;width:auto;object-fit:contain;background:#fff;border-radius:10px;padding:8px;box-shadow:0 0 15px rgba(0,0,0,0.2);}
.main{flex:1;display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:40px;padding:40px;}
.card{background:var(--card);border-radius:24px;padding:36px;box-shadow:0 10px 25px rgba(0,0,0,0.08);flex:1 1 460px;max-width:560px;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;border-top:8px solid var(--orange);transition:transform 0.3s ease, box-shadow 0.3s ease;}
.card:hover{transform:translateY(-4px);box-shadow:0 14px 35px rgba(0,0,0,0.12);}
.title{font-size:46px;color:var(--dark);font-weight:900;margin-bottom:28px;text-transform:uppercase;letter-spacing:1px;}
.info{display:flex;flex-direction:column;gap:16px;font-size:38px;font-weight:600;color:var(--dark);}
.info strong{color:var(--orange);font-weight:800;}
.footer{padding:20px 40px;text-align:right;color:var(--muted);font-size:28px;background:#EFEFEF;border-top:3px solid var(--orange);}
.center{display:flex;align-items:center;justify-content:center;height:100%;font-size:36px;color:var(--dark);}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-title">
      <img src="logo.png" alt="Logo MC Soluções" class="logo-img">
      <div class="logo-dot"></div>
      <div>Painel de Resultados</div>
    </div>
  </header>

  <div class="main" id="main-content">
    <div class="center" id="loading-indicator">Carregando dados...</div>
  </div>

  <div class="footer">MC Soluções ©</div>
</div>

<script>
// ============ CONFIG ============
const fontes = [
  { id: "CREF19", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1116505710&single=true&output=csv" },
  { id: "CREF20", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=195629568&single=true&output=csv" },
  { id: "CREF21", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=2070528577&single=true&output=csv" },
  { id: "CRTR02", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1484490409&single=true&output=csv" },
  { id: "CRTR08", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1600799136&single=true&output=csv" },
  { id: "CRTR15", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1264950541&single=true&output=csv" },
  { id: "CRN11", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1667393760&single=true&output=csv" },
  { id: "AMMV - PIX", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1154375239&single=true&output=csv" },
  { id: "AMMV - ENEL", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=393476796&single=true&output=csv" },
  { id: "STCASA", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=808693567&single=true&output=csv" }
];

const REFRESH_MS = 10000;       // fetch a cada 10s
const PAGE_RELOAD_MS = 15000;   // reload completo a cada 15s (cache-busting)
let cache = {};

// ============ HELPERS ============
// CSV parser robusto: respeita aspas e vírgulas dentro de campos
function parseCSV(text){
  const rows = [];
  let cur = '', row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++){
    const ch = text[i];
    if (ch === '"' ) {
      // se próximo também é ", é escape de quote
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if (!inQuotes && (ch === '\n' || ch === '\r')) {
      if (cur !== '' || row.length) { row.push(cur); rows.push(row.map(c=>c.trim())); }
      cur = ''; row = [];
      // pular \r\n
      if (ch === '\r' && text[i+1] === '\n') i++;
      continue;
    }
    if (!inQuotes && ch === ',') {
      row.push(cur); cur = ''; continue;
    }
    cur += ch;
  }
  // último campo
  if (cur !== '' || row.length) { row.push(cur); rows.push(row.map(c=>c.trim())); }
  // remover linhas completamente vazias
  return rows.filter(r => r.some(c => c !== ''));
}

function normalizeText(s){
  if(s===undefined || s===null) return "";
  return String(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase();
}

function toNumber(v){
  if(v === undefined || v === null) return 0;
  // já é número?
  if(typeof v === "number") return isFinite(v)?v:0;
  let s = String(v).trim();
  if(s === "" ) return 0;
  // remove R$, espaços, porcentagem, etc
  s = s.replace(/\s/g,"").replace(/R\$|r\$|%/g,"");
  // Sevieram vírgulas como separador decimal e ponto como milhar: 30.000,00 -> 30000.00
  // Remover tudo que não número, ponto ou vírgula, hífen
  s = s.replace(/[^0-9\-,.]/g,"");
  // Se há tanto '.' quanto ',', assumir '.' milhar e ',' decimal -> trocar '.' por '' e ',' por '.'
  if(s.indexOf('.') !== -1 && s.indexOf(',') !== -1){
    s = s.replace(/\./g,'').replace(/,/g,'.');
  } else if(s.indexOf(',') !== -1 && s.indexOf('.') === -1){
    // só vírgula -> decimal
    s = s.replace(/,/g,'.');
  } else {
    // só pontos (pode ser 30000 or 30.000) -> remover pontos
    s = s.replace(/\./g,'');
  }
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}

function formatBR(v){
  return v?.toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}) || 'R$ 0';
}

async function fetchAndParse(url){
  try{
    const res = await fetch(url + "&nocache=" + Date.now(), { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const txt = await res.text();
    return parseCSV(txt);
  }catch(e){
    console.error("fetch error:", e);
    return null;
  }
}

// encontra cabeçalho e mapeia colunas por sinônimos
function findHeaderMapping(rows){
  const synonyms = {
    proj: ['projecao', 'projecao mes','projecao_mensal','projecao mês','projecao_mes','projecao','projecao_mes','projecao mensal','projecao_mês','projecao%','projecao%','projecao porcento','projecao%'],
    total: ['pago total','valor total','valor total captado','valor total captado','total','valor captado','pago_total','valor_total','totalcaptado'],
    hoje: ['pago hoje','pagos hoje','pagohoje','pago_hoje','hoje','pagos_hoje']
  };

  for(let i=0;i<rows.length;i++){
    const row = rows[i];
    const norm = row.map(c => normalizeText(c));
    const mapping = {};
    for(let j=0;j<norm.length;j++){
      const c = norm[j];
      if(!c) continue;
      // checar cada sinônimo como substring
      for(const key in synonyms){
        for(const syn of synonyms[key]){
          const synNorm = syn.replace(/\s/g,'');
          if(c.includes(syn) || c.includes(synNorm) || syn.includes(c)) {
            mapping[key] = j;
            break;
          }
        }
        if(mapping[key] !== undefined) break;
      }
    }
    // se encontramos pelo menos total ou hoje, retornamos
    if(mapping.total !== undefined || mapping.hoje !== undefined || mapping.proj !== undefined){
      return { headerIdx: i, mapping };
    }
  }
  return null;
}

// fallback heuristics: da uma linha de dados, escolhe a coluna com maior valor (provavelmente total) ou penúltima, etc.
function heuristicPickTotal(dataRow){
  const nums = dataRow.map(c => toNumber(c));
  // pegar maior valor absoluto
  let max = 0, idx = -1;
  for(let i=0;i<nums.length;i++){
    if(nums[i] > max){ max = nums[i]; idx = i; }
  }
  return { idx, max };
}

// ============ LOAD / RENDER ============
async function loadAll(){
  for(const f of fontes){
    const rows = await fetchAndParse(f.url);
    if(!rows){ cache[f.id] = null; continue; }

    // meta: procurar linha que comece com 'meta' (ou 'meta mensal')
    let meta = 0;
    const metaRow = rows.find(r => normalizeText(r[0]).includes('meta'));
    if(metaRow) meta = toNumber(metaRow[1]);

    // localizar cabeçalho
    const headerInfo = findHeaderMapping(rows);
    let total = 0, lastPay = 0, projPercent = 0, projRaw = 0;

    if(headerInfo){
      const { headerIdx, mapping } = headerInfo;
      const dataRow = rows[headerIdx + 1] || [];

      if(mapping.total !== undefined) total = toNumber(dataRow[mapping.total]);
      if(mapping.hoje !== undefined) lastPay = toNumber(dataRow[mapping.hoje]);
      if(mapping.proj !== undefined) projRaw = toNumber(dataRow[mapping.proj]);

      // fallback se total for zero: tentar heurística na dataRow
      if((!total || total === 0) && dataRow.length){
        const h = heuristicPickTotal(dataRow);
        if(h.max > 0) total = h.max;
      }

      projPercent = meta ? Math.round((total / meta) * 100) : (projRaw ? Math.round(projRaw) : 0);

    } else {
      // fallback global: procurar última linha com muitos números
      let found = false;
      for(let i = rows.length - 1; i >= 0; i--){
        const line = rows[i].map(c => c.trim()).filter(c => c !== '');
        if(line.length >= 2){
          // extrair números e pegar maiores
          const nums = line.map(c => toNumber(c)).filter(n=>n>0);
          if(nums.length){
            // assumir que o maior é o total e o último é o Pago Hoje
            const sorted = [...nums].sort((a,b)=>b-a);
            total = sorted[0] || 0;
            lastPay = nums[nums.length-1] || 0;
            found = true;
            break;
          }
        }
      }
      if(!found){
        total = 0; lastPay = 0; projPercent = 0;
      }
    }

    cache[f.id] = { meta, total, projPercent, lastPay };
  }

  document.getElementById('loading-indicator').style.display = 'none';
  renderAll();
}

function renderAll(){
  const main = document.getElementById('main-content');
  main.innerHTML = '';
  for(const f of fontes){
    const d = cache[f.id];
    const card = document.createElement('div');
    card.className = 'card';
    if(!d){
      card.innerHTML = `<div class="title">${f.id}</div><div>Sem dados</div>`;
      main.appendChild(card);
      continue;
    }
    card.innerHTML = `
      <div class="title">${f.id}</div>
      <div class="info">
        <div><strong>Meta Mês:</strong> ${formatBR(d.meta)}</div>
        <div><strong>Valor Total Captado:</strong> ${formatBR(d.total)}</div>
        <div><strong>Projeção:</strong> ${d.projPercent}%</div>
        <div><strong>Pagos Hoje:</strong> ${formatBR(d.lastPay)}</div>
      </div>
    `;
    main.appendChild(card);
  }
}

// inicial
loadAll();
setInterval(loadAll, REFRESH_MS);

// força reload completo para burlar cache (mas faz fetch também a cada REFRESH_MS)
setInterval(()=>{
  const urlBase = window.location.pathname + window.location.search.replace(/([?&])_=[^&]*/,'');
  const separator = urlBase.includes('?') ? '&' : '?';
  const newUrl = urlBase + separator + '_=' + Date.now();
  window.location.replace(newUrl);
}, PAGE_RELOAD_MS);
</script>
</body>
</html>
