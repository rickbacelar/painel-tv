<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Resultados - MC SoluÃ§Ãµes</title>
<style>
:root{
  --orange:#FF6B00;
  --dark:#2E2E2E;
  --bg:#F5F5F6;
  --card:#FFFFFF;
  --muted:#8A8A8A;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--dark);}
.app{display:flex;flex-direction:column;height:100%;}
header{
  background:linear-gradient(90deg,var(--dark) 0%, #3C3C3C 100%);
  color:white;
  padding:30px 50px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}
.header-title{display:flex;align-items:center;gap:30px;font-weight:900;font-size:48px;letter-spacing:1px;}
.logo-dot{width:30px;height:30px;border-radius:4px;background:var(--orange);box-shadow:0 4px 12px rgba(255,107,0,0.5);}
.logo-img{height:150px;width:auto;object-fit:contain;background:#fff;border-radius:6px;padding:6px;box-shadow:0 0 12px rgba(0,0,0,0.2);}
.main{
  flex:1;
  display:grid;
  justify-items:center;
  align-items:center;
  gap:30px;
  padding:30px;
}
.card{
  background:var(--card);
  border-radius:24px;
  padding:60px 40px;
  min-height:400px;
  box-shadow:0 12px 25px rgba(0,0,0,0.12);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  border-top:8px solid var(--orange);
  transition:transform 0.3s ease,box-shadow 0.3s ease;
}
.title{font-size:4rem;color:var(--dark);font-weight:900;margin-bottom:30px;text-transform:uppercase;letter-spacing:1.5px;}
.info{display:flex;flex-direction:column;gap:20px;font-size:2.5rem;font-weight:700;color:var(--dark);}
.info strong{color:var(--orange);}
.footer{
  padding:25px 50px;
  text-align:center;
  color:var(--muted);
  font-size:22px;
  background:#EFEFEF;
  border-top:2px solid var(--orange);
  font-weight:700;
  letter-spacing:0.5px;
}
.center{display:flex;align-items:center;justify-content:center;height:100%;font-size:3rem;color:var(--dark);}

/* === DESTAQUE DA SEMANA COBRANÃ‡A === */
.destaque-semana{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100%;
  text-align:center;
  animation:fadeIn 1.5s ease;
}

.destaque-card{
  background: linear-gradient(135deg, var(--orange) 0%, #ff9330 100%);
  border-radius:40px;
  padding:80px 100px;
  color:white;
  box-shadow:0 0 30px rgba(0,0,0,0.3);
  animation: brilhar 2s infinite alternate;
}

@keyframes brilhar{
  from{box-shadow:0 0 20px rgba(255,255,255,0.4);}
  to{box-shadow:0 0 50px rgba(255,255,255,0.9);}
}

@keyframes fadeIn{
  from{opacity:0; transform:scale(0.95);}
  to{opacity:1; transform:scale(1);}
}

.foto-destaque{
  width:350px;
  height:350px;
  object-fit:cover;
  border-radius:50%;
  border:8px solid white;
  margin:40px 0;
  box-shadow:0 0 25px rgba(255,255,255,0.6);
}

.estrelas{
  font-size:3rem;
  color:gold;
  text-shadow:0 0 15px rgba(255,255,255,0.8);
  margin-bottom:10px;
}

.destaque-card h1{
  font-size:3.5rem;
  margin-bottom:25px;
  text-shadow:0 3px 10px rgba(0,0,0,0.3);
}

.destaque-card h2{
  font-size:3rem;
  margin-bottom:20px;
}

.destaque-card p{
  font-size:2rem;
  margin-top:15px;
  font-weight:600;
}

/* efeito de clique (leve flash visual) */
body:active {
  opacity: 0.85;
  transition: opacity 0.15s;
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-title">
      <img src="logo.png" alt="Logo MC SoluÃ§Ãµes" class="logo-img">
      <div class="logo-dot"></div>
      <div>Painel de Resultados</div>
    </div>
  </header>

  <div class="main" id="main-content">
    <div class="center" id="loading-indicator">Carregando dados...</div>
  </div>

  <div class="footer">MC SoluÃ§Ãµes Â©</div>
</div>

<script>
const fontes = [
  { id: "CREF19", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1116505710&single=true&output=csv" },
  { id: "CREF20", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=195629568&single=true&output=csv" },
  { id: "CREF21", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=2070528577&single=true&output=csv" },
  { id: "CRTR02", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1484490409&single=true&output=csv" },
  { id: "CRTR08", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1600799136&single=true&output=csv" },
  { id: "CRTR15", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1264950541&single=true&output=csv" },
  { id: "CRN11", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1667393760&single=true&output=csv" },
  { id: "AMMV - PIX", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1154375239&single=true&output=csv" },
  { id: "AMMV - ENEL", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=393476796&single=true&output=csv" },
  { id: "STCASA", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=808693567&single=true&output=csv" }
];
const DESTAQUE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1188185218&single=true&output=csv";

const PAGE_DURATION = 30000; 
let cache = {}, currentPage = 0, pages = [], destaqueInfo = null;

/* === PARSER CSV === */
function parseCSV(text) {
  const rows = [];
  let insideQuote = false, value = "", row = [];
  for (let c of text) {
    if (c === '"') insideQuote = !insideQuote;
    else if (c === ',' && !insideQuote) { row.push(value.trim()); value = ""; }
    else if ((c === '\n' || c === '\r') && !insideQuote) {
      if (value || row.length) { row.push(value.trim()); rows.push(row); row = []; value = ""; }
    } else value += c;
  }
  if (value || row.length) row.push(value.trim()), rows.push(row);
  return rows.filter(r => r.length > 0);
}

/* === FunÃ§Ãµes auxiliares === */
function normalize(s){return s?String(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim().toLowerCase():"";}
function toNumber(v){if(!v)return 0;let s=String(v).replace(/\s|R\$|r\$|%/g,"");s=s.replace(/\./g,"").replace(/,/g,".");const n=parseFloat(s);return isNaN(n)?0:n;}
function formatBR(v){return(toNumber(v)).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});}
function findExactHeader(rows){for(let i=0;i<rows.length;i++){const n=rows[i].map(c=>normalize(c));if(n.some(c=>c.includes("dias trabalh")||c.includes("pago total")||c.includes("pago hoje")||c.includes("projecao")||c.includes("projeÃ§Ã£o")))return{headerIdx:i,norm:n}}return null;}
async function fetchAndParse(url){
  try {
    const r=await fetch(url+(url.includes("?")?"&":"?")+"nocache="+Date.now(),{cache:"no-store"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    const t=await r.text();
    return parseCSV(t);
  } catch(e) {
    console.error("Erro ao buscar",url,e);
    return null;
  }
}

/* === Leitura e exibiÃ§Ã£o === */
async function loadAll(){
  for(const f of fontes){
    const rows=await fetchAndParse(f.url);
    if(!rows){cache[f.id]=null;continue;}
    const metaRow=rows.find(r=>normalize(r[0]).includes("meta"));const meta=metaRow?toNumber(metaRow[1]):0;
    const h=findExactHeader(rows);let total=0,last=0,proj=0;
    if(h){
      const d=rows[h.headerIdx+1]||[],n=h.norm;
      const ip=n.findIndex(c=>c.includes("projecao")||c.includes("projeÃ§Ã£o"));
      const it=n.findIndex(c=>c.includes("pago total")||c.includes("valor total"));
      const ih=n.findIndex(c=>c.includes("pago hoje"));
      if(it>=0) total=toNumber(d[it]);
      if(ih>=0) last=toNumber(d[ih]);
      if(ip>=0){const v=d[ip];proj=String(v).includes("%")?Math.round(toNumber(v)):meta?Math.round(toNumber(v)/meta*100):Math.round(toNumber(v));}
    }
    cache[f.id]={meta,total,projPercent:proj,lastPay:last};
  }

  // === Destaque da Semana ===
  const dr=await fetchAndParse(DESTAQUE_URL);
  if(dr && dr.length>1){
    const headers = dr[0].map(x => x.trim());
    const data = dr[1].map(x => x.trim());
    destaqueInfo = Object.fromEntries(headers.map((h,i)=>[h, data[i] || ""]));
  }

  document.getElementById("loading-indicator").style.display="none";
  preparePages();
  showPage(0);
  setInterval(nextPage, PAGE_DURATION);
}

/* === CartÃµes === */
function createCard(f){
  const d=cache[f.id];
  const c=document.createElement("div");c.className="card";
  if(!d){
    c.innerHTML=`<div class="title">${f.id}</div><div>Sem dados</div>`;
  }else{
    c.innerHTML=`<div class="title">${f.id}</div><div class="info">
    <div><strong>Meta MÃªs:</strong> ${formatBR(d.meta)}</div>
    <div><strong>Valor Total Captado:</strong> ${formatBR(d.total)}</div>
    <div><strong>ProjeÃ§Ã£o:</strong> ${d.projPercent}%</div>
    <div><strong>Pagos Hoje:</strong> ${formatBR(d.lastPay)}</div></div>`;
  }
  return c;
}

function createDestaqueCard(){
  const n=(destaqueInfo && (destaqueInfo["Nome"] || destaqueInfo["nome"])) || "Colaborador(a) em destaque";
  let f=(destaqueInfo && (destaqueInfo["Foto URL"] || destaqueInfo["foto"] || destaqueInfo["Foto"])) || "";
  const m=(destaqueInfo && (destaqueInfo["Mensagem"] || destaqueInfo["mensagem"])) || "ParabÃ©ns pelo excelente desempenho na semana!";

  // Corrige link do Drive automaticamente
  if(f.includes("drive.google.com")){
    const match=f.match(/[-\w]{25,}/);
    if(match) f=`https://drive.google.com/uc?id=${match[0]}`;
  }

  const c=document.createElement("div");c.className="destaque-semana";
  c.innerHTML=`
  <div class="destaque-card">
    <h1>ðŸŒŸ Destaque da Semana - CobranÃ§a ðŸŒŸ</h1>
    <img id="foto-destaque" src="${f}?t=${Date.now()}" alt="Destaque" class="foto-destaque" onerror="this.src='destaque.jpg'">
    <h2>${n}</h2>
    <div class="estrelas">â˜…â˜…â˜…â˜…â˜…</div>
    <p>${m}</p>
  </div>`;
  return c;
}

/* === PÃ¡ginas === */
function preparePages(){
  pages=[
    ["CREF19","CREF20","CREF21"].map(i=>createCard(fontes.find(f=>f.id===i))),
    ["CRTR02","CRTR08","CRTR15","CRN11"].map(i=>createCard(fontes.find(f=>f.id===i))),
    ["AMMV - PIX","AMMV - ENEL","STCASA"].map(i=>createCard(fontes.find(f=>f.id===i))),
    [createDestaqueCard()]
  ];
}

function showPage(i){
  currentPage=i;
  const m=document.getElementById("main-content");
  m.innerHTML="";
  const c=pages[i];
  if(!c)return;
  m.style.gridTemplateColumns=`repeat(${c.length},1fr)`;
  c.forEach(e=>m.appendChild(e));
}

function nextPage(){
  showPage((currentPage+1)%pages.length);
}

/* AtualizaÃ§Ã£o automÃ¡tica a cada 2 minutos */
setInterval(()=>{window.location.replace(window.location.pathname+"?_="+Date.now())},120000);

/* Clique manual para avanÃ§ar */
document.addEventListener("click",()=>nextPage());

loadAll();
</script>
</body>
</html>
