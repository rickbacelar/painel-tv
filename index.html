<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Painel de Resultados - MC SoluÃ§Ãµes</title>
<style>
:root{
  --orange:#FF6B00;
  --dark:#2E2E2E;
  --bg:#F5F5F6;
  --card:#FFFFFF;
  --muted:#8A8A8A;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--dark);}
.app{display:flex;flex-direction:column;height:100%;}
header{
  background:linear-gradient(90deg,var(--dark) 0%, #3C3C3C 100%);
  color:white;
  padding:30px 50px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}

.header-title{display:flex;align-items:center;gap:30px;font-weight:900;font-size:48px;letter-spacing:1px;}
.logo-dot{width:30px;height:30px;border-radius:4px;background:var(--orange);box-shadow:0 4px 12px rgba(255,107,0,0.5);}
.logo-img{height:150px;width:auto;object-fit:contain;background:#fff;border-radius:6px;padding:6px;box-shadow:0 0 12px rgba(0,0,0,0.2);}
.main{
  flex:1;
  display:grid;
  justify-items:center;
  align-items:center;
  gap:30px;
  padding:30px;
}
.card{
  background:var(--card);
  border-radius:24px;
  padding:60px 40px;
  min-height:400px;
  box-shadow:0 12px 25px rgba(0,0,0,0.12);
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  text-align:center;
  border-top:8px solid var(--orange);
  transition:transform 0.3s ease,box-shadow 0.3s ease;
}
.title{font-size:4rem;color:var(--dark);font-weight:900;margin-bottom:30px;text-transform:uppercase;letter-spacing:1.5px;}
.info{display:flex;flex-direction:column;gap:20px;font-size:2.5rem;font-weight:700;color:var(--dark);}
.info strong{color:var(--orange);}
.footer{
  padding:25px 50px;
  text-align:center;
  color:var(--muted);
  font-size:22px;
  background:#EFEFEF;
  border-top:2px solid var(--orange);
  font-weight:700;
  letter-spacing:0.5px;
}
.center{display:flex;align-items:center;justify-content:center;height:100%;font-size:3rem;color:var(--dark);}

/* === DESTAQUE DA SEMANA COBRANÃ‡A === */
.destaque-semana{
  display:flex;
  align-items:center;
  justify-content:center;
  height:100%;
  text-align:center;
  animation:fadeIn 1.5s ease;
  max-height:100vh;
  overflow:hidden;
}

.destaque-card{
  background: linear-gradient(135deg, var(--orange) 0%, #ff9330 100%);
  border-radius:40px;
  padding:40px 60px; /* reduzido */
  color:white;
  box-shadow:0 0 30px rgba(0,0,0,0.3);
  animation: brilhar 2s infinite alternate;
  max-height:90vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
}

.foto-destaque{
  width:280px; /* menor */
  height:280px;
  object-fit:cover;
  border-radius:50%;
  border:8px solid white;
  margin:25px 0;
  box-shadow:0 0 25px rgba(255,255,255,0.6);
}

.estrelas{
  font-size:2.4rem; /* menor */
  color:gold;
  text-shadow:0 0 10px rgba(255,255,255,0.8);
  margin-bottom:8px;
}

.destaque-card h1{
  font-size:3rem; /* menor */
  margin-bottom:15px;
  text-shadow:0 3px 10px rgba(0,0,0,0.3);
}

.destaque-card h2{
  font-size:2.5rem; /* menor */
  margin-bottom:15px;
}

.destaque-card p{
  font-size:1.7rem; /* menor */
  margin-top:10px;
  font-weight:600;
  max-width:90%;
  margin-left:auto;
  margin-right:auto;
  line-height:1.4;
}


/* efeito de clique (leve flash visual) */
body:active {
  opacity: 0.85;
  transition: opacity 0.15s;
}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-title">
      <img src="logo.png" alt="Logo MC SoluÃ§Ãµes" class="logo-img">
      <div class="logo-dot"></div>
      <div>Painel de Resultados</div>
    </div>
  </header>

  <div class="main" id="main-content">
    <div class="center" id="loading-indicator">Carregando dados...</div>
  </div>

  <div class="footer">MC SoluÃ§Ãµes Â©</div>
</div>

<script>
/* ------------- CONFIG ------------- */
const fontes = [
  { id: "CREF19", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1116505710&single=true&output=csv" },
  { id: "CREF20", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=195629568&single=true&output=csv" },
  { id: "CREF21", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=2070528577&single=true&output=csv" },
  { id: "CRTR02", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1484490409&single=true&output=csv" },
  { id: "CRTR08", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1600799136&single=true&output=csv" },
  { id: "CRTR15", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1264950541&single=true&output=csv" },
  { id: "CRN11", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1667393760&single=true&output=csv" },
  { id: "AMMV - PIX", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1154375239&single=true&output=csv" },
  { id: "AMMV - ENEL", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=393476796&single=true&output=csv" },
  { id: "STCASA", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=808693567&single=true&output=csv" }
];
const DESTAQUE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRZt529CoSQvc13l8kopidVIRoEMCHSLFy9A-xJ9Ij440qac25VRLjDjPpskRPBOA/pub?gid=1188185218&single=true&output=csv";
const PAGE_DURATION = 30000; // 30s

/* ------------- STATE ------------- */
let cache = {};
let pages = [];
let currentPage = 0;
let destaqueInfo = null;

/* ------------- UTIL ------------- */
function parseCSV(text) {
  // robust CSV parser (handles quoted fields with commas/newlines)
  const rows = [];
  let cur = "", row = [], inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; continue; }
      inQuotes = !inQuotes;
      continue;
    }
    if (!inQuotes && ch === ',') { row.push(cur); cur = ""; continue; }
    if (!inQuotes && (ch === '\n' || ch === '\r')) {
      if (cur !== "" || row.length) { row.push(cur); rows.push(row.map(c=>c.trim())); }
      cur = ""; row = [];
      if (ch === '\r' && text[i+1] === '\n') i++;
      continue;
    }
    cur += ch;
  }
  if (cur !== "" || row.length) { row.push(cur); rows.push(row.map(c=>c.trim())); }
  return rows.filter(r => r.some(c => c !== ""));
}
function normalize(s){ return s? String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase() : ''; }
function toNumber(v){
  if(v===undefined || v===null) return 0;
  if(typeof v === 'number') return isFinite(v)?v:0;
  let s = String(v).trim();
  if(!s) return 0;
  s = s.replace(/\s/g,'').replace(/R\$|r\$|%/g,'');
  // handle thousands and decimals
  if(s.indexOf('.') !== -1 && s.indexOf(',') !== -1){ s = s.replace(/\./g,'').replace(/,/g,'.'); }
  else if(s.indexOf(',') !== -1 && s.indexOf('.') === -1){ s = s.replace(/,/g,'.'); }
  else { s = s.replace(/\./g,''); }
  const n = parseFloat(s);
  return isNaN(n) ? 0 : n;
}
function formatBR(v){ return (typeof v === 'number' ? v : toNumber(v)).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:2}); }
async function fetchAndParse(url){
  try{
    const res = await fetch(url + (url.includes('?') ? '&' : '?') + "nocache=" + Date.now(), { cache: 'no-store' });
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    return parseCSV(text);
  }catch(e){
    console.error('fetch error for', url, e);
    return null;
  }
}

/* ------------- heurÃ­sticas para identificar header/data ------------- */
function findHeaderRow(rows){
  // procura linhas que tenham keywords (aceita variaÃ§Ãµes)
  const keywords = ['projec','projeÃ§Ã£o','pago total','pagohoje','pago hoje','valor total','dias trabalh','pago hoje','projecao'];
  for(let i=0;i<rows.length;i++){
    const norm = rows[i].map(c=>normalize(c)).join(' ');
    for(const k of keywords) if(norm.includes(k)) return i;
  }
  // fallback: a primeira linha que contenha "pago" ou "projec" em algum campo
  for(let i=0;i<rows.length;i++){
    if(rows[i].some(c => normalize(c).includes('pago') || normalize(c).includes('projec'))) return i;
  }
  return null;
}
function buildHeaderMap(headerRow){
  const map = {};
  for(let i=0;i<headerRow.length;i++){
    const h = normalize(headerRow[i]||'');
    map[h] = i;
  }
  return map;
}
function findBestDataRow(rows, headerIdx){
  // prefer next row; se vazia, achar a primeira linha que contenha nÃºmero BR (R$) ou dÃ­gitos
  const maybe = rows[headerIdx+1];
  if(maybe && maybe.some(c=>/[0-9]/.test(c))) return maybe;
  for(let i=headerIdx+1;i<rows.length;i++){
    if(rows[i].some(c=>/[0-9]/.test(c))) return rows[i];
  }
  return maybe || rows[headerIdx+1] || [];
}

/* ------------- Load everything ------------- */
async function loadAll(){
  console.log('Iniciando loadAll...');
  for(const f of fontes){
    console.log('Carregando fonte:', f.id, f.url);
    const rows = await fetchAndParse(f.url);
    console.log(`Preview ${f.id}:`, rows && rows.slice(0,6));
    if(!rows){ cache[f.id] = null; continue; }

    // tentativa 1: achar header que contenha os nomes esperados
    let headerIdx = findHeaderRow(rows);
    if (headerIdx === null) {
      // se nÃ£o encontrou header, assumir primeira linha como header
      headerIdx = 0;
    }

    const headerRow = rows[headerIdx];
    const headerMap = buildHeaderMap(headerRow);
    const dataRow = findBestDataRow(rows, headerIdx) || [];

    // extract by known names (com mÃºltiplas variaÃ§Ãµes)
    const getByNames = (names) => {
      for(const name of names){
        const key = Object.keys(headerMap).find(k => k.includes(normalize(name)));
        if(key) return dataRow[headerMap[key]];
      }
      // fallback: try find any column containing R$ in header or data
      for(let j=0;j<headerRow.length;j++){
        if(String(headerRow[j]).toLowerCase().includes('meta') && dataRow[j]) return dataRow[j];
      }
      return undefined;
    };

    const metaCandidates = ['meta mensal','meta mÃªs','meta','meta mensal (r$)'];
    const pagoTotalCandidates = ['pago total','valor total','total','valor total captado','pago_total'];
    const pagoHojeCandidates = ['pago hoje','pagos hoje','pagohoje','pago_hj','pago hoje (r$)'];
    const projCandidates = ['projec','projeÃ§Ã£o','projecao','projecao mes','projecao mÃªs'];

    let meta = getByNames(metaCandidates);
    let total = getByNames(pagoTotalCandidates);
    let lastPay = getByNames(pagoHojeCandidates);
    let proj = getByNames(projCandidates);

    // se ainda undefined, tentar pegar por posiÃ§Ã£o relativa (heurÃ­stica)
    if((meta===undefined || meta===null || meta==='') && rows.length>0){
      // procurar na planilha por qualquer cÃ©lula com "meta" em qualquer linha
      for(const r of rows){
        for(let i=0;i<r.length;i++){
          if(normalize(r[i]||'').includes('meta')) { meta = r[i+1] || meta; break; }
        }
        if(meta) break;
      }
    }

    if((total===undefined || total===null || total==='') || (lastPay===undefined || lastPay===null || lastPay==='')){
      // tentar detectar linha de dados pela presenÃ§a de R$ ou nÃºmeros grande (fallback)
      const dataLine = rows.find(r => r.some(c => /R\$|[0-9]{2,}\.[0-9]{3}|[0-9]{3,}/.test(String(c))));
      if(dataLine){
        // heurÃ­stica: buscar columns with numbers and assume order if header not found
        const numbers = dataLine.map(c=> toNumber(c));
        // try to assign: pick largest as total, pick a smaller as lastPay
        const sorted = numbers.map((v,i)=>({v,i})).sort((a,b)=>b.v-a.v);
        if(sorted.length>0 && (!total || toNumber(total)===0)) total = dataLine[sorted[0].i];
        if(sorted.length>1 && (!lastPay || toNumber(lastPay)===0)) lastPay = dataLine[sorted[1].i];
      }
    }

    // convert values safely
    const metaN = toNumber(meta);
    const totalN = toNumber(total);
    const lastPayN = toNumber(lastPay);
    let projPercent = 0;
    if(proj && String(proj).includes('%')) projPercent = Math.round(toNumber(proj));
    else if(proj && toNumber(proj)>0 && metaN>0) projPercent = Math.round( (toNumber(proj) / metaN) * 100 );
    else if(metaN>0) projPercent = Math.round( (totalN / metaN) * 100 );

    cache[f.id] = {
      meta: metaN,
      total: totalN,
      projPercent,
      lastPay: lastPayN
    };

    console.log(`Fonte ${f.id} -> meta:${metaN}, total:${totalN}, proj:${projPercent}, last:${lastPayN}`);
    if(metaN===0 || totalN===0) console.warn(`Valores possivelmente incorretos para ${f.id} â€” verifique cabeÃ§alhos na planilha ou veja preview no console.`);
  }

  // DESTAQUE
  console.log('Carregando destaque:', DESTAQUE_URL);
  const destaqueRows = await fetchAndParse(DESTAQUE_URL);
  console.log('Preview destaque:', destaqueRows && destaqueRows.slice(0,6));
  if(destaqueRows && destaqueRows.length>1){
    const headers = destaqueRows[0].map(h=>h.trim());
    const data = destaqueRows[1].map(h=>h.trim());
    const obj = {};
    for(let i=0;i<headers.length;i++) obj[headers[i]] = data[i] || "";
    // normalize known keys
    const keysLower = Object.fromEntries(Object.keys(obj).map(k => [normalize(k), obj[k]]));
    destaqueInfo = {
      Nome: obj['Nome'] || obj['nome'] || keysLower['nome'] || keysLower['name'] || "",
      FotoURL: obj['Foto URL'] || obj['Foto'] || obj['foto url'] || obj['foto'] || keysLower['foto url'] || keysLower['foto'] || "",
      Mensagem: obj['Mensagem'] || obj['mensagem'] || keysLower['mensagem'] || ""
    };
    console.log('Destaque lido:', destaqueInfo);
  } else {
    destaqueInfo = null;
  }

  document.getElementById('loading-indicator').style.display = 'none';
  preparePages();
  showPage(0);
  setInterval(nextPage, PAGE_DURATION);
}

/* ------------- RENDER ------------- */
function createCard(f){
  const d = cache[f.id];
  const card = document.createElement('div');
  card.className = 'card';
  if(!d){
    card.innerHTML = `<div class="title">${f.id}</div><div>Sem dados</div>`;
  } else {
    card.innerHTML = `
      <div class="title">${f.id}</div>
      <div class="info">
        <div><strong>Meta MÃªs:</strong> ${formatBR(d.meta)}</div>
        <div><strong>Valor Total Captado:</strong> ${formatBR(d.total)}</div>
        <div><strong>ProjeÃ§Ã£o:</strong> ${d.projPercent}%</div>
        <div><strong>Pagos Hoje:</strong> ${formatBR(d.lastPay)}</div>
      </div>
    `;
  }
  return card;
}

function createDestaqueCard(){
  const nome = (destaqueInfo && (destaqueInfo.Nome)) || "Colaborador(a) em destaque";
  let foto = (destaqueInfo && (destaqueInfo.FotoURL)) || "";
  const msg = (destaqueInfo && (destaqueInfo.Mensagem)) || "ParabÃ©ns pelo excelente desempenho na semana!";

  // normalizar link do Google Drive para uc?id=
  if(foto && foto.includes('drive.google.com')){
    const idMatch = foto.match(/[-\w]{25,}/);
    if(idMatch) foto = `https://drive.google.com/uc?id=${idMatch[0]}`;
  }

  // append anti-cache timestamp
  if(foto && !foto.includes('?')) foto = foto + '?t=' + Date.now();
  else if(foto) foto = foto + '&t=' + Date.now();

  const div = document.createElement('div');
  div.className = 'destaque-semana';
  div.innerHTML = `
    <div class="destaque-card">
      <h1>ðŸŒŸ Destaque da Semana - CobranÃ§a ðŸŒŸ</h1>
      <img id="foto-destaque" src="${foto}" alt="Destaque" class="foto-destaque" referrerpolicy="no-referrer" onerror="this.src='destaque.jpg'">
      <h2>${nome}</h2>
      <div class="estrelas">â˜…â˜…â˜…â˜…â˜…</div>
      <p>${msg}</p>
    </div>
  `;
  return div;
}

function preparePages(){
  pages = [
    ["CREF19","CREF20","CREF21"].map(id => createCard(fontes.find(f=>f.id===id))),
    ["CRTR02","CRTR08","CRTR15","CRN11"].map(id => createCard(fontes.find(f=>f.id===id))),
    ["AMMV - PIX","AMMV - ENEL","STCASA"].map(id => createCard(fontes.find(f=>f.id===id))),
    [createDestaqueCard()]
  ];
}

function showPage(idx){
  currentPage = idx;
  const main = document.getElementById('main-content');
  main.innerHTML = '';
  const cards = pages[idx];
  if(!cards) return;
  main.style.gridTemplateColumns = `repeat(${cards.length}, 1fr)`;
  cards.forEach(c=> main.appendChild(c));
}
function nextPage(){ showPage((currentPage+1) % pages.length); }

/* ------------- auto reload and click advance ------------- */
setInterval(()=>{ window.location.replace(window.location.pathname + '?_=' + Date.now()); }, 120000); // 2 min refresh
document.addEventListener('click', ()=> nextPage());

/* ------------- start ------------- */
loadAll();
</script>
</body>
</html>
